---
layout: post
title: Mysql误删库表后数据恢复
categories: Mysql
description: Mysql从删库到跑路的痛苦经历
---
Mysql误删库表后数据恢复

### 事故发生原因
今天用workbench想对测试库的表进行逆向工程导出数据模型，结果错点了“正向导入”一路next导致直接把测试库的所有表给干掉了，很难受！
Linux系统版本：Centos6.6
Mysql版本：5.6.25 Community

### 分析
迅速把解决方法定位到“Mysql误删表后如何恢复”，如果日常有定时备份脚本当然再好不过，直接可以用上个时间点的sql恢复，但是我们的测试库没有备份，所以尝试用恢复log-bin操作日志的方式
1. 查看测试服务器上的my.cnf配置
```config
datadir=/var/lib/mysql
log-bin=mysql-bin
```
查看mysql存储目录
```shell
[root@centos1 mysql]# pwd
/var/lib/mysql
[root@centos1 mysql]# ls
auto.cnf     mysql-bin.000001  mysql-bin.000012  mysql-bin.000023  mysql-bin.000034  mysql-bin.000045    point_bank               rtmap_guangf           xsmm
beaconzone   mysql-bin.000002  mysql-bin.000013  mysql-bin.000024  mysql-bin.000035  mysql-bin.000046    promo                    rtmap_pay_v3           zhuawawa
doubleball   mysql-bin.000003  mysql-bin.000014  mysql-bin.000025  mysql-bin.000036  mysql-bin.000047    promo3                   rts_1@002e0@002e0      zhuawawa1
dragon_boat  mysql-bin.000004  mysql-bin.000015  mysql-bin.000026  mysql-bin.000037  mysql-bin.000048    promo3@002dfull          run_game
ibdata1      mysql-bin.000005  mysql-bin.000016  mysql-bin.000027  mysql-bin.000038  mysql-bin.000049    promo3_back20            settlement@002dsystem
ib_logfile0  mysql-bin.000006  mysql-bin.000017  mysql-bin.000028  mysql-bin.000039  mysql-bin.000050    promo3_report            shake_promo
ib_logfile1  mysql-bin.000007  mysql-bin.000018  mysql-bin.000029  mysql-bin.000040  mysql-bin.000051    promo_test               sys_core
ka_lightapp  mysql-bin.000008  mysql-bin.000019  mysql-bin.000030  mysql-bin.000041  mysql-bin.index     rtmap@002dcoupon         template_platform
mt           mysql-bin.000009  mysql-bin.000020  mysql-bin.000031  mysql-bin.000042  mysql.sock          rtmap_dsp_1@002e0@002e0  test
mtp          mysql-bin.000010  mysql-bin.000021  mysql-bin.000032  mysql-bin.000043  ouya                rtmap_framework          vter
mysql        mysql-bin.000011  mysql-bin.000022  mysql-bin.000033  mysql-bin.000044  performance_schema  rtmap_game               wisdom_map
[root@centos1 mysql]# ls
# 查看最近bin-log修改时间
```
2. 确定哪些bin-log文件是和被删除库相关的
根据查看最近的bin-log文件的修改时间，确定了mysql-bin.000045 mysql-bin.000046 mysql-bin.000047 mysql-bin.000048，如果这个方法行不通那就只能是根据bin-log文件转换成sql文件后，用grep管道或者less进行匹配你想看的库或表
```shell
mysqlbinlog /var/lib/mysql/mysql-bin.000048 > /opt/backup/000048.sql
```
3. 确定删除表的position
```shell
less 000048.sql
# shift+G定位到最后，然后利用J/K键进行定位，最终定位结果是end_log_pos = 870195071 和 时间点 2017-04-12 10:15:52
# at 870194939
#170412 10:15:52 server id 1  end_log_pos 870195071 CRC32 0x4004aa5a    Query   thread_id=9851  exec_time=0     error_code=0
SET TIMESTAMP=1491963352/*!*/;
SET @@session.foreign_key_checks=0, @@session.unique_checks=0/*!*/;
SET @@session.sql_mode=1608515584/*!*/;
/*!\C utf8 *//*!*/;
SET @@session.character_set_client=33,@@session.collation_connection=33,@@session.collation_server=45/*!*/;
ALTER SCHEMA `rts_1.0.0`  DEFAULT COLLATE utf8mb4_general_ci
/*!*/;
# at 870195071
#170412 10:15:52 server id 1  end_log_pos 870195220 CRC32 0x7e25daa0    Query   thread_id=9851  exec_time=0     error_code=0
use `rts_1.0.0`/*!*/;
SET TIMESTAMP=1491963352/*!*/;
DROP TABLE IF EXISTS `t_rts_enterprise` /* generated by server */
/*!*/;
```
注意：end_log_pos = 870195071 和 时间点 2017-04-12 10:15:52 相当重要，后续需要用它来做恢复点

4. 利用bin-log开始恢复或者mysqlbinlog转换成sql恢复
```shell
[root@centos1 backup]# mysqlbinlog --help

# 按时间点恢复
mysqlbinlog -d rts_1.0.0 --stop-datetime="2017-04-12 10:15:52" mysql-bin.000045 mysql-bin.000046 mysql-bin.000047 mysql-bin.000048 | mysql -uroot-p

# 按position恢复
mysqlbinlog -d rts_1.0.0 --end-position="870195071" mysql-bin.000045 mysql-bin.000046 mysql-bin.000047 mysql-bin.000048 | mysql -uroot-p
```

```shell
# 导出sql
mysqlbinlog -d rts_1.0.0 --stop-datetime="2017-04-12 10:15:52" mysql-bin.000045 mysql-bin.000046 mysql-bin.000047 mysql-bin.000048 > /opt/backup/backup0412.sql
# 恢复sql
mysql -u root -p < /opt/backup/backup0412.sql
```

5. 恢复期间遇到的问题

5.1 mysqlbinlog命令执行失败,检查/etc/my.cnf [client] 下
注释default-character-set=utf8
5.2 mysqlbinlog在对function恢复时，发生错误中断了恢复操作，需要在/etc/my.cnf里的[mysqld]下加入
log_bin_trust_function_creators = 1



### 总结
1. 每次操作数据库表需要慎重，杜绝事故发生，建立不同权限的用户，规范使用用户名
2. 做好日常备份
```shell
# autoBackupMysql.sh
#!/bin/bash
backup_dir=/opt/backup/mysql/
database=--all-databases
dbStruct=all-stuct
dbData=all-data
DATE=`date +%Y%m%d%H%m%s`
dumpStructFile=$backup_dir$dbStruct-$DATE.sql
dumpDataFile=$backup_dir$dbData-$DATE.sql
# backup table struct
/usr/bin/mysqldump -uroot -proot --default-character-set=utf8 --opt -d $database > $dumpStructFile
# backup table data
/usr/bin/mysqldump -uroot -proot --default-character-set=utf8 -t $database > $dumpDataFile

# exit
chmod +x autoBackupMysql.sh
```
然后加入crontab启动计划里
```shell
crontab -e
# 分　时　日　月　周
0 0 * * * /root/shell/autoBackupMysql.sh
```
![crontab格式说明](http://img.blog.csdn.net/20160804170302727)
